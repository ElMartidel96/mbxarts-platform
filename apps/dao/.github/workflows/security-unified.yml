name: ðŸ›¡ï¸ Security & Quality Gate (Comprehensive)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-quality-check:
    name: ðŸ” Complete Security & Quality Validation
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      CI: true
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: ðŸ“¦ Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.15.9
        run_install: false
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org/'
        cache: 'pnpm'
        cache-dependency-path: pnpm-lock.yaml
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ” Installing dependencies with pnpm $(pnpm --version)..."
        pnpm install --frozen-lockfile --prefer-offline
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        
    - name: ðŸ” TypeScript Compilation Check
      run: |
        set -o pipefail
        echo "## ðŸ” TypeScript Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        set +e
        pnpm run type-check > typescript-output.txt 2>&1
        TS_EXIT_CODE=$?
        set -e
        
        if [ $TS_EXIT_CODE -eq 0 ]; then
          echo "âœ… **TypeScript: PASSED** - No compilation errors" >> $GITHUB_STEP_SUMMARY
        else
          ERROR_COUNT=$(grep -c "error TS" typescript-output.txt || echo "0")
          echo "âŒ **TypeScript: $ERROR_COUNT errors found** (non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sample TypeScript Errors:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -10 typescript-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "âš ï¸ TypeScript check completed (non-blocking)"
      continue-on-error: true
        
    - name: ðŸ§¹ ESLint Security Rules
      run: |
        set -o pipefail
        echo "## ðŸ§¹ ESLint Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        set +e
        pnpm run lint > eslint-output.txt 2>&1
        ESLINT_EXIT_CODE=$?
        set -e
        
        if [ $ESLINT_EXIT_CODE -eq 0 ]; then
          echo "âœ… **ESLint: PASSED** - No linting issues found" >> $GITHUB_STEP_SUMMARY
        else
          ERROR_COUNT=$(grep -c "error" eslint-output.txt || echo "0")
          WARNING_COUNT=$(grep -c "warning" eslint-output.txt || echo "0")
          echo "âŒ **ESLint: Issues Found** - $ERROR_COUNT errors, $WARNING_COUNT warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ESLint Issues Summary:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -15 eslint-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "âš ï¸ ESLint check completed (non-blocking)"
      continue-on-error: true
        
    - name: ðŸ”’ Security Audit - Dependencies
      run: |
        echo "ðŸ“‹ Running pnpm audit..."
        pnpm audit --prod --audit-level=moderate || echo "âš ï¸ Vulnerabilities found but continuing"
      continue-on-error: true
        
    - name: ðŸ“Š Generate Audit Report
      if: always()
      run: |
        pnpm audit --json > audit-report.json || true
        echo "ðŸ“ Audit report generated"
      continue-on-error: true
        
    - name: ðŸ” Secret Scanning - TruffleHog
      if: github.event_name == 'pull_request'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true
        
    - name: ðŸ—ï¸ Build Project
      run: |
        echo "ðŸ”¨ Building project..."
        pnpm run build || echo "âš ï¸ Build errors found but continuing"
      continue-on-error: true
        
    - name: ðŸ“‹ Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        format: cyclonedx-json
        output-file: sbom.json
      continue-on-error: true
        
    - name: ðŸ“œ License Check
      run: |
        echo "ðŸ“œ Checking licenses..."
        npx license-checker --production --summary --excludePrivatePackages > licenses.txt || true
        if grep -E "(GPL|AGPL|LGPL|SSPL)" licenses.txt; then
          echo "::warning::Found copyleft licenses that may be incompatible"
        fi
      continue-on-error: true
        
    - name: ðŸŽ¯ SAST Analysis - Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/typescript
          p/react
          p/nextjs
      continue-on-error: true
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        
    - name: ðŸ“Š Summary Report
      if: always()
      run: |
        echo "## ðŸ›¡ï¸ Security & Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Checks Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- TypeScript Compilation" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint Security Rules" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency Audit" >> $GITHUB_STEP_SUMMARY
        echo "- Secret Scanning" >> $GITHUB_STEP_SUMMARY
        echo "- License Compliance" >> $GITHUB_STEP_SUMMARY
        echo "- SAST Analysis" >> $GITHUB_STEP_SUMMARY
        echo "- SBOM Generation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **Note:** This workflow is non-blocking. All issues are reported as warnings." >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“¤ Upload Security Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          audit-report.json
          licenses.txt
          sbom.json
        retention-days: 7