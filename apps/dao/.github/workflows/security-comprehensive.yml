name: ðŸ”’ Security Checks (Comprehensive)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday at 00:00 UTC

jobs:
  # Dependency audit with detailed reporting
  audit:
    name: ðŸ“¦ Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9
          run_install: false
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
      
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      
      - name: ðŸ” Run Comprehensive Audit
        run: |
          echo "## ðŸ“¦ Dependency Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run audit with multiple output formats
          set +e
          pnpm audit --json > audit-report-detailed.json 2>/dev/null || echo '{"error":"audit_failed"}' > audit-report-detailed.json
          pnpm audit --prod --audit-level=moderate > audit-output.txt 2>&1
          AUDIT_EXIT_CODE=$?
          set -e
          
          # Extract vulnerability counts from JSON
          if [ -f "audit-report-detailed.json" ] && [ -s "audit-report-detailed.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report-detailed.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report-detailed.json 2>/dev/null || echo "0") 
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report-detailed.json 2>/dev/null || echo "0")
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-report-detailed.json 2>/dev/null || echo "0")
            INFO=$(jq '.metadata.vulnerabilities.info // 0' audit-report-detailed.json 2>/dev/null || echo "0")
            TOTAL=$(jq '.metadata.vulnerabilities.total // 0' audit-report-detailed.json 2>/dev/null || echo "0")
          else
            CRITICAL="0"; HIGH="0"; MODERATE="0"; LOW="0"; INFO="0"; TOTAL="0"
          fi
          
          echo "### ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count | Status | Priority |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo "âœ… None" || echo "ðŸš¨ Immediate Action") | P0 |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH | $([ $HIGH -eq 0 ] && echo "âœ… None" || echo "âš ï¸ Action Required") | P1 |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderate | $MODERATE | $([ $MODERATE -eq 0 ] && echo "âœ… None" || echo "ðŸ“‹ Plan Fix") | P2 |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low | $LOW | $([ $LOW -eq 0 ] && echo "âœ… None" || echo "ðŸ‘€ Monitor") | P3 |" >> $GITHUB_STEP_SUMMARY
          echo "| â„¹ï¸ Info | $INFO | $([ $INFO -eq 0 ] && echo "âœ… None" || echo "ðŸ“– Review") | P4 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ˆ Total Vulnerabilities: $TOTAL**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL -eq 0 ]; then
            echo "ðŸŽ‰ **EXCELLENT** - No security vulnerabilities found in dependencies!" >> $GITHUB_STEP_SUMMARY
          elif [ $((CRITICAL + HIGH)) -eq 0 ]; then
            echo "âœ… **GOOD** - No critical or high-severity vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ATTENTION REQUIRED** - Critical or high-severity vulnerabilities need addressing" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: ðŸ“‹ Generate Audit Artifacts
        if: always()
        run: |
          # Create comprehensive audit report
          echo "Audit completed at: $(date -u)" > audit-summary.txt
          echo "Total packages audited: $(pnpm list --depth=0 2>/dev/null | grep -c "^[â”œâ””]" || echo "unknown")" >> audit-summary.txt
          
          # Generate fix recommendations if vulnerabilities exist
          if [ -f "audit-report-detailed.json" ] && [ -s "audit-report-detailed.json" ]; then
            jq -r '.advisories | to_entries[] | "Package: \(.value.module_name), Severity: \(.value.severity), Recommendation: \(.value.recommendation // "Update to latest version")"' audit-report-detailed.json > fix-recommendations.txt 2>/dev/null || echo "No specific recommendations available" > fix-recommendations.txt
          fi
      
      - name: ðŸ“¤ Upload Audit Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: |
            audit-report-detailed.json
            audit-output.txt
            audit-summary.txt
            fix-recommendations.txt
          retention-days: 30

  # SBOM generation for supply chain security
  sbom:
    name: ðŸ“‹ Software Bill of Materials (SBOM)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9
          run_install: false
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
      
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      
      - name: ðŸ”§ Install CycloneDX CLI
        run: npm install -g @cyclonedx/cyclonedx-npm
      
      - name: ðŸ“‹ Generate SBOM
        run: |
          echo "## ðŸ“‹ Software Bill of Materials (SBOM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate SBOM in multiple formats
          cyclonedx-npm --output-format json --output-file sbom.json
          cyclonedx-npm --output-format xml --output-file sbom.xml
          
          # Count components
          COMPONENT_COUNT=$(jq '.components | length' sbom.json 2>/dev/null || echo "unknown")
          
          echo "### ðŸ“Š SBOM Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Total Components:** $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… **Generated:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ **Format:** CycloneDX 1.4" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ **Outputs:** sbom.json, sbom.xml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… SBOM generation completed successfully"
      
      - name: ðŸ“¤ Upload SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: |
            sbom.json
            sbom.xml
          retention-days: 30
      
      - name: ðŸ” SBOM Analysis
        run: |
          echo "### ðŸ“Š SBOM Component Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analyze component types if jq is available
          if command -v jq >/dev/null 2>&1; then
            echo "#### Component Types:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            jq -r '.components[] | .type' sbom.json 2>/dev/null | sort | uniq -c | sort -nr >> $GITHUB_STEP_SUMMARY || echo "Analysis not available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Use Case:** SBOM enables supply chain security monitoring and compliance" >> $GITHUB_STEP_SUMMARY

  # Secret scanning with TruffleHog
  secrets:
    name: ðŸ” Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scanning
      
      - name: ðŸ” TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --json --output trufflehog-results.json
        continue-on-error: true
      
      - name: ðŸ“Š Process Secret Scan Results
        run: |
          echo "## ðŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "trufflehog-results.json" ] && [ -s "trufflehog-results.json" ]; then
            SECRET_COUNT=$(wc -l < trufflehog-results.json 2>/dev/null || echo "0")
            
            if [ "$SECRET_COUNT" -eq 0 ]; then
              echo "âœ… **No verified secrets detected** - Repository appears clean" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **$SECRET_COUNT potential secrets detected** - Review required" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸš¨ Action Required:" >> $GITHUB_STEP_SUMMARY
              echo "1. Review the uploaded secret scan report" >> $GITHUB_STEP_SUMMARY
              echo "2. Rotate any confirmed secrets immediately" >> $GITHUB_STEP_SUMMARY
              echo "3. Update .gitignore to prevent future exposure" >> $GITHUB_STEP_SUMMARY
              echo "4. Consider using secret management tools" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Secret scan completed** - No results file generated (likely no secrets found)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Scope:** Full repository history scanned for verified secrets" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: ðŸ“¤ Upload Secret Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: |
            trufflehog-results.json
          retention-days: 7 # Shorter retention for sensitive security data

  # Static Application Security Testing (SAST)
  sast:
    name: ðŸŽ¯ Static Application Security Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸŽ¯ Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/typescript
            p/react
            p/nextjs
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true
      
      - name: ðŸ“Š Generate SAST Summary
        run: |
          echo "## ðŸŽ¯ SAST Analysis Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Rulesets Applied:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Security Audit Rules" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”Ÿ OWASP Top 10" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“˜ TypeScript Security Patterns" >> $GITHUB_STEP_SUMMARY
          echo "- âš›ï¸ React Security Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Next.js Security Guidelines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Analysis:** Static security analysis completed - check Semgrep dashboard for detailed results" >> $GITHUB_STEP_SUMMARY

  # License compliance checking
  license:
    name: ðŸ“œ License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9
          run_install: false
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
      
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      
      - name: ðŸ”§ Install License Checker
        run: npm install -g license-checker
      
      - name: ðŸ“œ Check Licenses
        run: |
          echo "## ðŸ“œ License Compliance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate comprehensive license report
          license-checker --production --json > licenses-detailed.json
          license-checker --production --summary --excludePrivatePackages > licenses-summary.txt
          
          # Count licenses
          TOTAL_PACKAGES=$(jq 'keys | length' licenses-detailed.json 2>/dev/null || echo "unknown")
          
          echo "### ðŸ“Š License Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Total Packages:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… **Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for problematic licenses
          PROBLEMATIC_LICENSES=""
          if grep -iE "(GPL|AGPL|LGPL|SSPL|WTFPL)" licenses-summary.txt >/dev/null 2>&1; then
            PROBLEMATIC_LICENSES=$(grep -iE "(GPL|AGPL|LGPL|SSPL|WTFPL)" licenses-summary.txt || echo "")
          fi
          
          if [ -n "$PROBLEMATIC_LICENSES" ]; then
            echo "âš ï¸ **Potential License Issues Detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš¨ Copyleft/Restrictive Licenses Found:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$PROBLEMATIC_LICENSES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš–ï¸ Action Required:** Review these licenses for compatibility with your project" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **License Compliance: GOOD** - No problematic licenses detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Note:** Full license details are available in the uploaded artifacts" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Upload License Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            licenses-detailed.json
            licenses-summary.txt
          retention-days: 30

  # CodeQL Analysis for deeper security insights
  codeql:
    name: ðŸ§¬ CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ§¬ Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'javascript-typescript'
          queries: 'security-extended,security-and-quality'
          config-file: .github/codeql/codeql-config.yml
      
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2
      
      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript-typescript"
      
      - name: ðŸ“Š CodeQL Summary
        run: |
          echo "## ðŸ§¬ CodeQL Analysis Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Analysis Scope:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’» **Languages:** JavaScript, TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **Query Suite:** Security Extended + Quality" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Results:** Available in Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deep static analysis completed** - Check Security tab for detailed findings" >> $GITHUB_STEP_SUMMARY

  # Final security summary
  security-summary:
    name: ðŸ“Š Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [audit, sbom, secrets, sast, license, codeql]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Generate Comprehensive Security Summary
        run: |
          echo "## ðŸ›¡ï¸ Comprehensive Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Security Checks Completed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job results and generate summary
          echo "| Security Check | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependency Audit | ${{ needs.audit.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | Vulnerability scanning of dependencies |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ SBOM Generation | ${{ needs.sbom.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | Software Bill of Materials created |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Secret Scanning | ${{ needs.secrets.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | Repository scanned for exposed secrets |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ SAST Analysis | ${{ needs.sast.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | Static application security testing |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“œ License Check | ${{ needs.license.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | License compliance verification |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§¬ CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ… Completed' || 'âš ï¸ Check Required' }} | Deep semantic code analysis |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate overall security score
          PASSED_CHECKS=0
          [ "${{ needs.audit.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.sbom.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.secrets.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.sast.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.license.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.codeql.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          
          TOTAL_CHECKS=6
          SECURITY_SCORE=$(( (PASSED_CHECKS * 100) / TOTAL_CHECKS ))
          
          echo "### ðŸ† Overall Security Score: **${SECURITY_SCORE}%** ($PASSED_CHECKS/$TOTAL_CHECKS checks passed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $SECURITY_SCORE -eq 100 ]; then
            echo "ðŸŽ‰ **EXCELLENT SECURITY POSTURE** - All security checks passed!" >> $GITHUB_STEP_SUMMARY
          elif [ $SECURITY_SCORE -ge 80 ]; then
            echo "âœ… **GOOD SECURITY POSTURE** - Most checks passed, review any warnings" >> $GITHUB_STEP_SUMMARY
          elif [ $SECURITY_SCORE -ge 60 ]; then
            echo "âš ï¸ **MODERATE SECURITY POSTURE** - Several areas need attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš¨ **SECURITY ATTENTION REQUIRED** - Multiple critical issues need addressing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ” Review all uploaded security artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”§ Address any high-priority security findings" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“Š Monitor the Security tab for ongoing insights" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ”„ Regular security reviews (weekly scheduled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Next Scheduled Scan:** Every Monday at 00:00 UTC" >> $GITHUB_STEP_SUMMARY